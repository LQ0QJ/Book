{% extends "layouts/index.html" %}

{% block meta_tags %}
  <meta property="robots" content="noindex" />
{% endblock %}

{% block title %}
{% if (search_input | length) > 0 %}{{ gettext('page.search.title.results', search_input=search_input) }}{% else %}{{ gettext('page.search.title.new') }}{% endif %}
{% endblock %}

{% block body %}
  <form action="/search" method="get" role="search" class="js-search-form">
    <input type="hidden" name="index" value="{{ search_dict.search_index_short }}" class="js-search-form-index">

    <div class="flex flex-wrap mb-1 text-[#000000a3]" role="tablist" aria-label="file tabs">
      <a href="/search" class="custom-a mr-4 mb-2 border-b-[3px] border-transparent aria-selected:border-[#0095ff] aria-selected:text-black aria-selected:font-bold js-md5-tab-discussion" aria-selected="{{ 'true' if search_dict.search_index_short == '' else 'false' }}" id="md5-tab-discussion" aria-controls="md5-panel-discussion" tabindex="0" onclick="event.preventDefault(); document.querySelector('.js-search-form-index').value = ''; document.querySelector('.js-search-form').submit()">Download {% if (search_input | length) > 0 %}({{ search_dict.total_by_index_long.aarecords.value | numberformat }}{% if search_dict.total_by_index_long.aarecords.relation == 'gte' %}+{% endif %}){% endif %}</a>
      <a href="/search?index=digital_lending" class="custom-a mr-4 mb-2 border-b-[3px] border-transparent aria-selected:border-[#0095ff] aria-selected:text-black aria-selected:font-bold js-md5-tab-lists" aria-selected="{{ 'true' if search_dict.search_index_short == 'digital_lending' else 'false' }}" id="md5-tab-lists" aria-controls="md5-panel-lists" tabindex="0" onclick="event.preventDefault(); document.querySelector('.js-search-form-index').value = 'digital_lending'; document.querySelector('.js-search-form').submit()">Digital Lending {% if (search_input | length) > 0 %}({{ search_dict.total_by_index_long.aarecords_digital_lending.value | numberformat }}{% if search_dict.total_by_index_long.aarecords_digital_lending.relation == 'gte' %}+{% endif %}){% endif %}</a>
      <a href="/search?index=meta" class="custom-a mr-4 mb-2 border-b-[3px] border-transparent aria-selected:border-[#0095ff] aria-selected:text-black aria-selected:font-bold js-md5-tab-lists" aria-selected="{{ 'true' if search_dict.search_index_short == 'meta' else 'false' }}" id="md5-tab-lists" aria-controls="md5-panel-lists" tabindex="0" onclick="event.preventDefault(); document.querySelector('.js-search-form-index').value = 'meta'; document.querySelector('.js-search-form').submit()">Metadata {% if (search_input | length) > 0 %}({{ search_dict.total_by_index_long.aarecords_metadata.value | numberformat }}{% if search_dict.total_by_index_long.aarecords_metadata.relation == 'gte' %}+{% endif %}){% endif %}</a>
    </div>

    <div class="flex mb-2 items-center">
      <a href="#" class="custom-a sm:hidden text-lg mr-2 opacity-50 hover:opacity-100" alt="Filter settings" title="Filter settings" onclick="event.preventDefault(); document.querySelector('.js-search-filter-settings').classList.remove('max-sm:hidden'); document.body.style.overflow = 'hidden'"><span class="icon-[mingcute--settings-6-line]"></span></a>
      <input type="search" name="q" placeholder="{{ gettext('common.search.placeholder') }}" value="{{search_input}}" class="js-slash-focus grow bg-[#00000011] px-2 py-1 mr-2 rounded" {% if search_input == '' %}autofocus{% endif %} title="Focus: '/' Scroll search results: 'j', 'k'">
      <button class="sm:hidden text-[#777] hover:text-[#333]" type="submit">{{ gettext('common.search.submit') }}</button>
    </div>

    <div class="text-xs flex flex-wrap mb-4 sm:hidden">
      {% if (search_dict.aggregations.search_content_type | selectattr("selected") | list | length) > 0 %}
        <a href="#" class="rounded-sm flex mb-1 mr-1 pr-1 border border-[#ccc] opacity-60 hover:opacity-80 aria-selected:opacity-100 custom-a js-md5-codes-tabs-tab" onclick="event.preventDefault(); document.querySelector('.js-search-filter-settings').classList.remove('max-sm:hidden'); document.body.style.overflow = 'hidden'"><span class="py-[2px] bg-[#ccc] mr-1 px-1">{{ gettext('page.search.filters.content.header') }}</span><span class="py-[2px]">{% for bucket in search_dict.aggregations.search_content_type | selectattr("selected") %}{% if loop.index0 > 0 %}, {% endif %}{{ bucket.label }} ({{'{0:,}'.format(bucket.doc_count)}}){% endfor %}</span></a>
      {% endif %}
      {% if search_dict.search_index_short == '' %}
        {% if (search_dict.aggregations.search_extension | selectattr("selected") | list | length) > 0 %}
          <a href="#" class="rounded-sm flex mb-1 mr-1 pr-1 border border-[#ccc] opacity-60 hover:opacity-80 aria-selected:opacity-100 custom-a js-md5-codes-tabs-tab" onclick="event.preventDefault(); document.querySelector('.js-search-filter-settings').classList.remove('max-sm:hidden'); document.body.style.overflow = 'hidden'"><span class="py-[2px] bg-[#ccc] mr-1 px-1">{{ gettext('page.search.filters.filetype.header') }}</span><span class="py-[2px]">{% for bucket in search_dict.aggregations.search_extension | selectattr("selected") %}{% if loop.index0 > 0 %}, {% endif %}{{ bucket.label }} ({{'{0:,}'.format(bucket.doc_count)}}){% endfor %}</span></a>
        {% endif %}
      {% endif %}
      {% if (search_dict.aggregations.search_access_types | selectattr("selected") | list | length) > 0 %}
        <a href="#" class="rounded-sm flex mb-1 mr-1 pr-1 border border-[#ccc] opacity-60 hover:opacity-80 aria-selected:opacity-100 custom-a js-md5-codes-tabs-tab" onclick="event.preventDefault(); document.querySelector('.js-search-filter-settings').classList.remove('max-sm:hidden'); document.body.style.overflow = 'hidden'"><span class="py-[2px] bg-[#ccc] mr-1 px-1">{{ gettext('page.search.filters.access.header') }}</span><span class="py-[2px]">{% for bucket in search_dict.aggregations.search_access_types | selectattr("selected") %}{% if loop.index0 > 0 %}, {% endif %}{{ bucket.label }} ({{'{0:,}'.format(bucket.doc_count)}}){% endfor %}</span></a>
      {% endif %}
      {% if (search_dict.aggregations.search_record_sources | selectattr("selected") | list | length) > 0 %}
        <a href="#" class="rounded-sm flex mb-1 mr-1 pr-1 border border-[#ccc] opacity-60 hover:opacity-80 aria-selected:opacity-100 custom-a js-md5-codes-tabs-tab" onclick="event.preventDefault(); document.querySelector('.js-search-filter-settings').classList.remove('max-sm:hidden'); document.body.style.overflow = 'hidden'"><span class="py-[2px] bg-[#ccc] mr-1 px-1">{{ gettext('page.search.filters.source.header') }}</span><span class="py-[2px]">{% for bucket in search_dict.aggregations.search_record_sources | selectattr("selected") %}{% if loop.index0 > 0 %}, {% endif %}{{ bucket.label }} ({{'{0:,}'.format(bucket.doc_count)}}){% endfor %}</span></a>
      {% endif %}
      {% if search_dict.sort_value != '' %}
        <a href="#" class="rounded-sm flex mb-1 mr-1 pr-1 border border-[#ccc] opacity-60 hover:opacity-80 aria-selected:opacity-100 custom-a js-md5-codes-tabs-tab" onclick="event.preventDefault(); document.querySelector('.js-search-filter-settings').classList.remove('max-sm:hidden'); document.body.style.overflow = 'hidden'"><span class="py-[2px] bg-[#ccc] mr-1 px-1">{{ gettext('page.search.filters.order_by.header') }}</span><span class="py-[2px]">{% if search_dict.sort_value == 'newest' %}{{ gettext('page.search.filters.sorting.newest') }}{% endif %}{% if search_dict.sort_value == 'oldest' %}{{ gettext('page.search.filters.sorting.oldest') }}{% endif %}{% if search_dict.sort_value == 'largest' %}{{ gettext('page.search.filters.sorting.largest') }}{% endif %}{% if search_dict.sort_value == 'smallest' %}{{ gettext('page.search.filters.sorting.smallest') }}{% endif %}</span></a>
      {% endif %}
      {% if (search_dict.aggregations.search_most_likely_language_code | selectattr("selected") | list | length) > 0 %}
        <a href="#" class="rounded-sm flex mb-1 mr-1 pr-1 border border-[#ccc] opacity-60 hover:opacity-80 aria-selected:opacity-100 custom-a js-md5-codes-tabs-tab" onclick="event.preventDefault(); document.querySelector('.js-search-filter-settings').classList.remove('max-sm:hidden'); document.body.style.overflow = 'hidden'"><span class="py-[2px] bg-[#ccc] mr-1 px-1">{{ gettext('page.search.filters.language.header') }}</span><span class="py-[2px]">{% for bucket in search_dict.aggregations.search_most_likely_language_code | selectattr("selected") %}{% if loop.index0 > 0 %}, {% endif %}{{ bucket.label }} ({{'{0:,}'.format(bucket.doc_count)}}){% endfor %}</span></a>
      {% endif %}
    </div>

    <div class="flex w-[100%]">
      <div aria-labelledby="{{ gettext('page.search.search_settings') }}" class="max-sm:hidden sm:text-sm max-sm:cursor-pointer js-search-filter-settings max-sm:fixed max-sm:top-0 max-sm:bottom-0 max-sm:left-0 max-sm:right-0 max-sm:z-[999999999] max-sm:bg-[rgba(230,230,230,0.7)] max-sm:p-4 sm:w-[25%] sm:max-w-[240px] sm:shrink-0 md:pr-6 sm:pr-3" onclick="if(event.target === event.currentTarget) { event.preventDefault(); event.stopPropagation(); document.querySelector('.js-search-form').submit() }">
        <div class="max-sm:cursor-auto max-sm:shadow-2xl max-sm:rounded-xl max-sm:absolute max-sm:top-4 max-sm:bottom-4 max-sm:left-4 max-sm:right-4 max-sm:bg-white max-sm:p-4 max-sm:overflow-y-auto max-sm:mx-auto max-sm:max-w-[700px]">
          <button class="hidden sm:block bg-[#777] hover:bg-[#999] text-white font-bold py-1 px-3 rounded shadow mb-4" type="submit">{{ gettext('page.search.submit') }}</button>

          <div class="flex justify-between items-center mb-4 sm:hidden">
            <div class="font-bold text-lg">{{ gettext('page.search.search_settings') }}</div>
            <div class="">
              <button class="opacity-50 focus:opacity-80 hover:opacity-100" type="submit">✕</button>
            </div>
          </div>

          <div class="font-bold mb-1">{{ gettext('page.search.filters.content.header') }}</div>
          <div class="mb-4">
            {% for bucket in search_dict.aggregations.search_content_type %}
              <label class="flex cursor-pointer items-start {% if bucket.doc_count == 0 %}opacity-60{% endif %}"><input type="checkbox" class="mr-1 mt-[6px] sm:mt-1" name="content" value="{{bucket.key}}" {% if bucket.selected %}checked{% endif %}><span class="mr-1 flex-grow">{{bucket.label | replace('-', '&#8209;' | safe)}}</span><span class="mt-[2px] text-sm sm:text-xs text-gray-500">{{'{0:,}'.format(bucket.doc_count)}}</span></label>
            {% endfor %}
          </div>
          {% if search_dict.search_index_short == '' %}
            <div class="font-bold mb-1">{{ gettext('page.search.filters.filetype.header') }}</div>
            <div class="mb-4">
              {% for bucket in search_dict.aggregations.search_extension %}
                <label class="flex cursor-pointer items-start {% if bucket.doc_count == 0 %}opacity-60{% endif %}"><input type="checkbox" class="mr-1 mt-[6px] sm:mt-1" name="ext" value="{{bucket.key}}" {% if bucket.selected %}checked{% endif %}><span class="mr-1 flex-grow">{{bucket.label | replace('-', '&#8209;' | safe)}}</span><span class="mt-[2px] text-sm sm:text-xs text-gray-500">{{'{0:,}'.format(bucket.doc_count)}}</span></label>
              {% endfor %}
            </div>
          {% endif %}
          <div class="font-bold mb-1">Access</div>
          <div class="mb-4">
            {% for bucket in search_dict.aggregations.search_access_types %}
              <label class="flex cursor-pointer items-start {% if bucket.doc_count == 0 %}opacity-60{% endif %}"><input type="checkbox" class="mr-1 mt-[6px] sm:mt-1" name="acc" value="{{bucket.key}}" {% if bucket.selected %}checked{% endif %}><span class="mr-1 flex-grow">{{bucket.label | replace('-', '&#8209;')}}</span><span class="mt-[2px] text-sm sm:text-xs text-gray-500">{{'{0:,}'.format(bucket.doc_count)}}</span></label>
            {% endfor %}
          </div>
          <div class="font-bold mb-1">Source</div>
          <div class="mb-4">
            {% for bucket in search_dict.aggregations.search_record_sources %}
              <label class="flex cursor-pointer items-start {% if bucket.doc_count == 0 %}opacity-60{% endif %}"><input type="checkbox" class="mr-1 mt-[6px] sm:mt-1" name="src" value="{{bucket.key}}" {% if bucket.selected %}checked{% endif %}><span class="mr-1 flex-grow">{{bucket.label | replace('-', '&#8209;' | safe)}}</span><span class="mt-[2px] text-sm sm:text-xs text-gray-500">{{'{0:,}'.format(bucket.doc_count)}}</span></label>
            {% endfor %}
          </div>
          <div class="font-bold mb-1">Order by</div>
          <select class="pr-8 mb-4 bg-[#00000011] px-2 py-1 rounded" name="sort">
            <option value="">{{ gettext('page.search.filters.sorting.most_relevant') }}</option>
            <option value="newest" {% if search_dict.sort_value == 'newest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.newest') }}</option>
            <option value="oldest" {% if search_dict.sort_value == 'oldest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.oldest') }}</option>
            <option value="largest" {% if search_dict.sort_value == 'largest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.largest') }}</option>
            <option value="smallest" {% if search_dict.sort_value == 'smallest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.smallest') }}</option>
          </select>
          <div class="font-bold mb-1">{{ gettext('page.search.filters.language.header') }}</div>
          <div class="mb-4">
            {% for bucket in search_dict.aggregations.search_most_likely_language_code %}
              <label class="flex cursor-pointer items-start {% if bucket.doc_count == 0 %}opacity-60{% endif %} {% if loop.index > 10 %}hidden js-language-hidden{% endif %}"><input type="checkbox" class="mr-1 mt-[6px] sm:mt-1" name="lang" value="{{bucket.key}}" {% if bucket.selected %}checked{% endif %}><span class="mr-1 flex-grow">{{bucket.label | replace('-', '&#8209;' | safe)}}</span><span class="mt-[2px] text-sm sm:text-xs text-gray-500">{{'{0:,}'.format(bucket.doc_count)}}</span></label>
            {% endfor %}
            {% if search_dict.aggregations.search_most_likely_language_code | length > 10 %}
              <a href="#" onclick="event.preventDefault(); event.stopPropagation(); for(var el of document.querySelectorAll('.js-language-hidden')) { el.classList.remove('hidden') }; event.currentTarget.classList.add('hidden')">{{ gettext('page.search.more') }}</a>
            {% endif %}
          </div>
          <button class="bg-[#777] hover:bg-[#999] text-white font-bold py-1 px-3 rounded shadow mb-2" type="submit">{{ gettext('page.search.submit') }}</button>

          {% if g.last_data_refresh_date %}
            <div class="mt-4 mb-2" style="font-size: 90%; color: #555">{{ gettext('page.search.header.update_info', last_data_refresh_date=(g.last_data_refresh_date | dateformat('long')), link_open_tag=('<a href="/datasets">' | safe)) }}</div>
          {% endif %}
        </div>
      </div>

      <div class="min-w-[0] w-[100%]">
        {% if search_dict.had_es_timeout %}
          <p class="mt-4 font-bold">{{ gettext('page.search.results.error.header') }}</p>

          <p class="mt-4">{{ gettext('page.search.results.error.unknown', a_reload=(' href="javascript:location.reload()" ' | safe), email=('<a class="break-all" href="mailto:AnnaArchivist@proton.me">AnnaArchivist@proton.me</a>' | safe)) }}</p>
        {% elif (search_input | length) > 0 %}
          <!-- {% if redirect_pages.isbn_page %}
            <p class="my-4">That looks like it might be an ISBN. <a href="/isbn/{{ redirect_pages.isbn_page | urlencode }}">View our ISBN data page for “{{ redirect_pages.isbn_page }}”.</a></p>
          {% endif %}
          {% if redirect_pages.doi_page %}
            <p class="my-4">That looks like it might be a DOI. <a href="/doi/{{ redirect_pages.doi_page | urlencode }}">View our DOI data page for “{{ redirect_pages.doi_page }}”.</a></p>
          {% endif %}
          {% if redirect_pages.ol_page %}
            <p class="my-4">That looks like it might be an Open Library Edition ID. <a href="/ol/{{ redirect_pages.ol_page | urlencode }}">View our Open Library data page for “{{ redirect_pages.ol_page }}”.</a></p>
          {% endif %} -->

          {% if (search_dict.search_aarecords | length) == 0 %}
            <div class="mt-4">{{ gettext('page.search.results.none') }}</div>
          {% endif %}

          <div class="mb-4">
            {% from 'macros/aarecord_list.html' import aarecord_list %}
            {{ aarecord_list(search_dict.search_aarecords) }}

            {% if search_dict.additional_search_aarecords | length > 0 %}
              <div class="italic mt-8">{% if search_dict.max_additional_search_aarecords_reached %}{{ gettext('page.search.results.partial_more', num=(search_dict.additional_search_aarecords | length)) }}{% else %}{{ gettext('page.search.results.partial', num=(search_dict.additional_search_aarecords | length)) }}{% endif %}</div>

              {{ aarecord_list(search_dict.additional_search_aarecords, max_show_immediately=0) }}
            {% endif %}
          </div>
        {% else %}
          <div class="sm:mt-6 h-[50vh] sm:px-[20px] md:px-[60px]">
            {% if search_dict.search_index_short == '' %}
              <p class="mb-4">
                Type in the box to search our catalog of {{ g.header_stats.total }} directly downloadable files, which we <a href="/about">preserve forever</a>.
              </p>
              <p class="mb-4">
                We currently have the world’s most comprehensive open catalog of books, papers, and other written works. We mirror Sci-Hub, Library Genesis, Z-Library, <a href="/datasets">and more</a>.
              </p>
              <p class="mb-4">
                If you find other “shadow libraries” that we should mirror, or if you have any questions, please contact us at <a class="break-all" href="mailto:AnnaArchivist@proton.me">AnnaArchivist@proton.me</a>. For DMCA / copyright claims <a href="/copyright">click here</a>.
              </p>

              <p class="mb-4 max-sm:hidden text-sm text-gray-500">
                Tip: use keyboard shortcuts “/“ (search focus), “enter” (search), “j” (up), “k” (down) for quicker navigation.
              </p>
            {% elif search_dict.search_index_short == 'digital_lending' %}
              <p class="mb-4">
                Type in the box to search for files in digital lending libraries.
              </p>
              <p class="mb-4">
                This search index currently includes metadata from the Internet Archive’s Controlled Digital Lending library. <a href="/datasets">More about our datasets</a>.
              </p>
              <p class="mb-4">
                For more digital lending libraries, see <a href="https://en.wikipedia.org/wiki/E-book_lending">Wikipedia</a> and the <a href="https://wiki.mobileread.com/wiki/EBook_Lending_Libraries">MobileRead Wiki</a>.
              </p>
            {% elif search_dict.search_index_short == 'meta' %}
              <p class="mb-4">
                Type in the box to search for metadata from libraries. This can be useful when <a href="/account/request">requesting a file</a>.
              </p>
              <p class="mb-4">
                This search index currently includes metadata from ISBNdb and Open Library. <a href="/datasets">More about our datasets</a>.
              </p>
              <p class="mb-4">
                There are many, many sources of metadata for written works around the world. <a href="https://en.wikipedia.org/wiki/Wikipedia:Book_sources">This Wikipedia page</a> is a good start, but if you know of other good lists, please let us know.
              </p>
            {% else %}
              <p class="mb-4">
                Type in the box to search.
              </p>
            {% endif %}
          </div>
        {% endif %}
        
        {% if search_input != '' %}
          <script>
            (function() {
              const searchInput = {{ search_input | tojson }};
              try {
                if (window.sessionStorage['search_counted_' + searchInput] === "1") {
                  return;
                }
                window.sessionStorage['search_counted_' + searchInput] = "1";
              } catch(e) {
                console.error("Error with sessionStorage: ", e);
              }
              navigator.sendBeacon("/dyn/log_search?q=" + searchInput);
            })();
          </script>
        {% endif %}
      </div>
    </div>
  </form>
{% endblock %}
