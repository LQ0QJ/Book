{% extends "layouts/index.html" %}

{% block meta_tags %}
  <meta property="robots" content="noindex" />
{% endblock %}

{% block title %}
{% if (search_input | length) > 0 %}{{ gettext('page.search.title.results', search_input=search_input) }}{% else %}{{ gettext('page.search.title.new') }}{% endif %}
{% endblock %}

{% block body %}
  {% if (search_input | length) > 0 %}
    {% if search_dict %}
      <div class="mb-4">{% if search_dict.max_search_aarecords_reached %}{{ gettext('page.search.breadcrumbs.results_more', search_input=search_input, num=(search_dict.search_aarecords | length)) }}{% else %}{{ gettext('page.search.breadcrumbs.results', search_input=search_input, num=(search_dict.search_aarecords | length)) }}{% endif %}</div>
    {% else %}
      <div class="mb-4">{{ gettext('page.search.breadcrumbs.error', search_input=search_input) }}</div>
    {% endif %}
  {% else %}
    <div class="mb-4">{{ gettext('page.search.breadcrumbs.new') }}</div>
  {% endif %}

  {% if g.last_data_refresh_date %}
    <div class="mb-4" style="font-size: 90%; color: #555">{{ gettext('page.search.header.update_info', last_data_refresh_date=(g.last_data_refresh_date | dateformat('long')), link_open_tag=('<a href="/datasets">' | safe)) }}</div>
  {% endif %}

  <form action="/search" method="get" role="search" class="js-search-form">
    <input type="hidden" name="index" value="{{ search_dict.search_index_short }}" class="js-search-form-index">

    <div class="flex flex-wrap mb-1 text-[#000000a3]" role="tablist" aria-label="file tabs">
      <a href="/search" class="custom-a mr-4 mb-2 border-b-[3px] border-transparent aria-selected:border-[#0095ff] aria-selected:text-black aria-selected:font-bold js-md5-tab-discussion" aria-selected="{{ 'true' if search_dict.search_index_short == '' else 'false' }}" id="md5-tab-discussion" aria-controls="md5-panel-discussion" tabindex="0" onclick="event.preventDefault(); document.querySelector('.js-search-form-index').value = ''; document.querySelector('.js-search-form').submit()">Download</a>
      <a href="/search?index=digital_lending" class="custom-a mr-4 mb-2 border-b-[3px] border-transparent aria-selected:border-[#0095ff] aria-selected:text-black aria-selected:font-bold js-md5-tab-lists" aria-selected="{{ 'true' if search_dict.search_index_short == 'digital_lending' else 'false' }}" id="md5-tab-lists" aria-controls="md5-panel-lists" tabindex="0" onclick="event.preventDefault(); document.querySelector('.js-search-form-index').value = 'digital_lending'; document.querySelector('.js-search-form').submit()">Digital Lending</a>
    </div>

    <div class="flex mb-4 max-w-[600px]" style="font-size: 87%">
      <select class="grow w-[25%] bg-[#00000011] px-2 py-1 mr-2 rounded" name="lang">
        <option value="">{{ gettext('page.search.filters.language.header') }}</option>
        {% for bucket in search_dict.aggregations.search_most_likely_language_code %}
          <option value="{{bucket.key}}" {% if bucket.selected %}selected{% endif %}>{{bucket.label}} ({{'{0:,}'.format(bucket.doc_count)}})</option>
        {% endfor %}
      </select>
      <select class="grow w-[25%] bg-[#00000011] px-2 py-1 mr-2 rounded" name="content">
        <option value="">{{ gettext('page.search.filters.content.header') }}</option>
        {% for bucket in search_dict.aggregations.search_content_type %}
          <option value="{{bucket.key}}" {% if bucket.selected %}selected{% endif %}>{{bucket.label}} ({{'{0:,}'.format(bucket.doc_count)}})</option>
        {% endfor %}
      </select>
      <select class="grow w-[25%] bg-[#00000011] px-2 py-1 mr-2 rounded" name="ext">
        <option value="">{{ gettext('page.search.filters.filetype.header') }}</option>
        {% for bucket in search_dict.aggregations.search_extension %}
          <option value="{{bucket.key}}" {% if bucket.selected %}selected{% endif %}>{{bucket.label}} ({{'{0:,}'.format(bucket.doc_count)}})</option>
        {% endfor %}
      </select>
      <select class="grow w-[25%] bg-[#00000011] px-2 py-1 mr-2 rounded" name="sort">
        <option value="">{{ gettext('page.search.filters.sorting.most_relevant') }}</option>
        <option value="newest" {% if search_dict.sort_value == 'newest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.newest') }}</option>
        <option value="oldest" {% if search_dict.sort_value == 'oldest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.oldest') }}</option>
        <option value="largest" {% if search_dict.sort_value == 'largest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.largest') }}</option>
        <option value="smallest" {% if search_dict.sort_value == 'smallest' %}selected{% endif %}>{{ gettext('page.search.filters.sorting.smallest') }}</option>
      </select>
    </div>

    <div class="flex mb-4">
      <input type="search" name="q" placeholder="{{ gettext('common.search.placeholder') }}" value="{{search_input}}" class="js-slash-focus grow bg-[#00000011] px-2 py-1 mr-2 rounded" {% if search_input == '' %}autofocus{% endif %} title="Focus: '/' Scroll search results: 'j', 'k'">
      <button class="text-[#777] hover:text-[#333]" type="submit">{{ gettext('common.search.submit') }}</button>
    </div>
  </form>

  {% if (search_input | length) > 0 %}
    {% if redirect_pages.isbn_page %}
      <p class="my-4">That looks like it might be an ISBN. <a href="/isbn/{{ redirect_pages.isbn_page | urlencode }}">View our ISBN data page for “{{ redirect_pages.isbn_page }}”.</a></p>
    {% endif %}
    {% if redirect_pages.doi_page %}
      <p class="my-4">That looks like it might be a DOI. <a href="/doi/{{ redirect_pages.doi_page | urlencode }}">View our DOI data page for “{{ redirect_pages.doi_page }}”.</a></p>
    {% endif %}
    {% if redirect_pages.ol_page %}
      <p class="my-4">That looks like it might be an Open Library Edition ID. <a href="/ol/{{ redirect_pages.ol_page | urlencode }}">View our Open Library data page for “{{ redirect_pages.ol_page }}”.</a></p>
    {% endif %}

    {% if not search_dict %}
      <p class="mt-4 font-bold">{{ gettext('page.search.results.error.header') }}</p>

      <p class="mt-4">{{ gettext('page.search.results.error.text') }}</p>
    {% else %}
      {% if (search_dict.search_aarecords | length) == 0 %}
        <div class="mt-4">{{ gettext('page.search.results.none') }}</div>
      {% endif %}

      <div class="mb-4">
        {% from 'macros/aarecord_list.html' import aarecord_list %}
        {{ aarecord_list(search_dict.search_aarecords) }}

        {% if search_dict.additional_search_aarecords | length > 0 %}
          <div class="italic mt-8">{% if search_dict.max_additional_search_aarecords_reached %}{{ gettext('page.search.results.partial_more', num=(search_dict.additional_search_aarecords | length)) }}{% else %}{{ gettext('page.search.results.partial', num=(search_dict.additional_search_aarecords | length)) }}{% endif %}</div>

          {{ aarecord_list(search_dict.additional_search_aarecords, max_show_immediately=0) }}
        {% endif %}
      </div>
    {% endif %}
  {% endif %}
  
  {% if search_input != '' %}
    <script>
      (function() {
        const searchInput = {{ search_input | tojson }};
        try {
          if (window.sessionStorage['search_counted_' + searchInput] === "1") {
            return;
          }
          window.sessionStorage['search_counted_' + searchInput] = "1";
        } catch(e) {
          console.error("Error with sessionStorage: ", e);
        }
        navigator.sendBeacon("/dyn/log_search?q=" + searchInput);
      })();
    </script>
  {% endif %}
{% endblock %}
