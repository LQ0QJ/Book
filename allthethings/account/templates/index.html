{% extends "layouts/index.html" %}

{% block title %}Account{% endblock %}

{% block body %}
  <script>
    function accountOnSubmit(event, url) {
      event.preventDefault();

      const currentTarget = event.currentTarget;
      const fieldset = currentTarget.querySelector("fieldset");
      currentTarget.querySelector(".js-failure").classList.add("hidden");

      // Before disabling the fieldset.
      fetch(url, { method: "PUT", body: new FormData(currentTarget) })
        .then(function(response) {
          if (!response.ok) { throw "error"; }
          return response.json().then(function(jsonResponse) {
            if (jsonResponse.aa_logged_in !== undefined) {
              window.globalUpdateAaLoggedIn(jsonResponse.aa_logged_in);
            }
            fieldset.classList.add("hidden");
            currentTarget.querySelector(".js-success").classList.remove("hidden");
          });
        })
        .catch(function() {
          fieldset.removeAttribute("disabled", "disabled");
          fieldset.style.opacity = 1;
          currentTarget.querySelector(".js-failure").classList.remove("hidden");
        })
        .finally(function() {
          currentTarget.querySelector(".js-spinner").classList.add("invisible");
        });

      fieldset.setAttribute("disabled", "disabled");
      fieldset.style.opacity = 0.5;
      currentTarget.querySelector(".js-spinner").classList.remove("invisible");
    }
  </script>

  {% if email %}
    <h2 class="mt-4 mb-1 text-3xl font-bold">Account</h2>

    <script>window.globalUpdateAaLoggedIn(1);</script>
    <form autocomplete="on" onsubmit="accountOnSubmit(event, '/dyn/account/logout/')">
      <fieldset class="mb-4">
        <p class="mb-4">You are logged in as {{ email }}.</p>
        <button type="submit" class="mt-2 mr-2 bg-[#777] hover:bg-[#999] text-white font-bold py-2 px-4 rounded shadow">Logout</button>
        <span class="invisible mb-[-3px] text-xl text-[#555] inline-block icon-[svg-spinners--ring-resize]"></span>
      </fieldset>
      <div class="hidden js-success">✅ You are now logged out. Reload the page to log in again.</div>
      <div class="hidden js-failure">❌ Something went wrong. Please reload the page and try again.</div>
    </form>
  {% else %}
    <h2 class="mt-4 mb-1 text-3xl font-bold">Log in / Register</h2>

    <form autocomplete="on" onsubmit="accountOnSubmit(event, '/dyn/account/access/')">
      <fieldset class="mb-4">
        <p class="mb-4">Enter your email address. If you don’t have an account yet, a new one will be created.</p>
        <p class="mb-4">We will never share or display your email address.</p>
        <input type="email" id="email" name="email" required placeholder="anna@example.org" class="js-account-email w-[100%] max-w-[400px] bg-[#00000011] px-2 py-1 mr-2 rounded" />
        <br/>
        <button type="submit" class="mt-2 mr-2 bg-[#777] hover:bg-[#999] text-white font-bold py-2 px-4 rounded shadow">Send login email</button>
        <span class="invisible mb-[-3px] text-xl text-[#555] inline-block icon-[svg-spinners--ring-resize]"></span>
      </fieldset>
      <div class="hidden js-success">✅ Sent! Check your email inbox. If you don’t see anything, wait a minute, and check your spam folder.</div>
      <div class="hidden js-failure">❌ Something went wrong. Please reload the page and try again.</div>
    </form>
  {% endif %}
{% endblock %}
