{% extends "layouts/index.html" %}

{% block title %}Account{% endblock %}

{% block body %}
  <script>
    let accountEmailUsedForError;
    function accountShowError(email, msg) {
      accountEmailUsedForError = email;
      const errorMsgEl = document.querySelector(".js-account-email-validation-error-msg");
      errorMsgEl.innerText = msg + " Submit again to try anyway.";
      errorMsgEl.classList.remove("hidden");
    }

    function accountHideError() {
      accountEmailUsedForError = undefined;
      const errorMsgEl = document.querySelector(".js-account-email-validation-error-msg");
      errorMsgEl.classList.add("hidden");
    }

    function accountValidateEmail(event) {
      event.preventDefault();
      const currentTarget = event.currentTarget;
      const email = new FormData(currentTarget).get('email');

      if (accountEmailUsedForError === email) {
        return true;
      }

      const otherProblematicDomains = ["21cn.com"]
      if (otherProblematicDomains.some((domain) => email.endsWith(domain))) {
        accountShowError(email, "We are currently having issues delivering to this provider. Please use a different email. See below for suggestions.");
        return false;
      }
      if (window.emailMisspelled.microsoft.some((domain) => email.endsWith(domain))) {
        accountShowError(email, "We are currently having issues delivering to Microsoft accounts. Please use a different email. See below for suggestions.");
        return false;
      }
      suggestions = window.emailMisspelled.emailMisspelled({ domains: window.emailMisspelled.all })(email);
      if (suggestions.length > 0) {
        accountShowError(email, "Did you mean “" + suggestions[0].suggest + "”? Please double check!");
        return false;
      }
      if (!/^\S+@\S+\.\S+$/.test(email) || email.endsWith(".con")) {
        accountShowError(email, "It looks like you misspelled your email address. Please double check!");
        return false;
      }

      accountHideError();
      return true;
    }
  </script>

  {% if gettext('common.english_only') | trim %}
    <p class="mb-4 font-bold">{{ gettext('common.english_only') }}</p>
  {% endif %}

  <div lang="en">
    {% if account_dict %}
      <h2 class="mt-4 mb-4 text-3xl font-bold">Account</h2>

      <script>window.globalUpdateAaLoggedIn(1);</script>
      
      {% from 'macros/profile_link.html' import profile_link %}
      <div>Public profile: {{ profile_link(account_dict, account_dict.account_id) }}</div>
      <div>Email: <strong>{{ account_dict.email_verified }}</strong> (never publicly shown)</div>
      <div class="mb-4">
        Membership:
        {% if account_dict.membership_tier == "0" %}
          <strong>None</strong> <a href="/donate">(become a member)</a>
        {% else %}
          <strong>{{ MEMBERSHIP_TIER_NAMES[account_dict.membership_tier] }}</strong> until {{ account_dict.membership_expiration | dateformat(format='long') }} <a href="/donate?tier={{ account_dict.membership_tier }}">(extend)</a></div>
        {% endif %}
      </div>

      <form autocomplete="on" onsubmit="window.submitForm(event, '/dyn/account/logout/', (jsonResponse) => { window.globalUpdateAaLoggedIn(jsonResponse.aa_logged_in); })" class="mb-8">
        <fieldset class="mb-4">
          <button type="submit" class="mr-2 bg-[#777] hover:bg-[#999] text-white font-bold py-1 px-3 rounded shadow">Logout</button>
          <span class="js-spinner invisible mb-[-3px] text-xl text-[#555] inline-block icon-[svg-spinners--ring-resize]"></span>
        </fieldset>
        <div class="hidden js-success">✅ You are now logged out. Reload the page to log in again.</div>
        <div class="hidden js-failure">❌ Something went wrong. Please reload the page and try again.</div>
      </form>
    {% else %}
      <h2 class="mt-4 mb-4 text-3xl font-bold">Log in / Register</h2>

      <form autocomplete="on" onsubmit="if (accountValidateEmail(event)) {window.submitForm(event, '/dyn/account/access/'); document.querySelector('.js-account-sent-email').innerText = document.getElementById('email').value }" class="mb-4">
        <fieldset class="mb-4">
          <p class="mb-4">Enter your email address to login or register. We do not use passwords.</p>
          <input type="email" id="email" name="email" required placeholder="anna@example.org" class="js-account-email w-[100%] max-w-[400px] bg-[#00000011] px-2 py-1 mr-2 rounded mb-1" />
          <p class="mb-4 text-sm text-gray-500">We never share or display your email address.</p>
          <div class="js-account-email-validation-error-msg hidden mb-4 text-red-500"></div>
          <div class="mb-4">
            <button type="submit" class="mr-2 bg-[#777] hover:bg-[#999] text-white font-bold py-1 px-3 rounded shadow">Send login email</button>
            <span class="js-spinner invisible mb-[-3px] text-xl text-[#555] inline-block icon-[svg-spinners--ring-resize]"></span>
          </div>
          <p class="mb-4">
            We are currently having issues delivering to Microsoft accounts: outlook.com, hotmail.com, live.com, msn.com. Please use a different email.
          </p>
          <p class="mb-4">
            If you need a quick email address because your main email doesn’t work, we recommend using <a href="https://proton.me/" rel="noopener noreferrer" target="_blank">Proton Mail</a> (free).
          </p>
        </fieldset>
        <div class="hidden js-success">✅ Sent to <strong class="js-account-sent-email"></strong>! Check your email inbox. If you don’t see anything, wait a minute, and check your spam folder. If that doesn’t work, contact us at <a href="mailto:AnnaArchivist@proton.me">AnnaArchivist@&#8203;proton.&#8203;me</a>.</div>
        <div class="hidden js-failure">❌ Something went wrong. Please reload the page and try again.</div>
      </form>
    {% endif %}
  </div>
{% endblock %}
